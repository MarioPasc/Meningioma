# Meningioma/preprocessing/tools submodule

This submodule contains all the python tools that are being used in the preprocessing pipeline. Some tools may be external libraries located at Meningioma/external. The current files included in tools are:

1. `remove_extra_channles.py`. Includes a tool that reads a nrrd file path, and, if the volume contains more than one channel, then it removes the first channel, which mayb be realted to complex data or other echo times on T2 pulses. The function makes the necessary changes in the header orderedDict and returns the input volume as an `sitk.Image` object.
2. `nrrd_to_nifti.py`. This is a customized tools originally coded in [here](https://github.com/pnlbwh/conversion/blob/master/conversion/nifti_write.py) for DWT RM images. In the current implementation of this library, the tool is adapted to only work with sMRI images. Currently, the tools accepts the nrrd path as an input, or, a Tuple of `(sitk.Image, collections.OrderedDict)`, containing the volume and the header. The function translated the nrrd header to nifti header, and return the path to the `nii.gz` file.
3. `casting.py`. This file contains a simple casting functionality for the volume and mask. The volume is casted into a `float32` dtype, while the mask is casted to a `np.uint8` dtype. The minimum intensity of the mask is being set to zero, while the maximum intensity if being set to one.
4. `reorient.py`. Provides the functionality to standarize the orientation of the volumes and masks to a standard medical orientation formal. By default, it is set to LPS, the standard DICOM format. More information in [this link](https://theaisummer.com/medical-image-coordinates/#the-coordinate-systems-in-medical-imaging).
5. `resample.py`. Standarizes the pixel resolution to fit the real-coordinates desired voxel format. The default value is $1x1x1$ $mm^3$. When the input volume has a lower voxel size then the desired, some segmentation masks and slices may be lost due to undersampling to fit the desired voxel size. However, when the adquisition voxel depth is higher than the desired voxel size, the interpolator is used to generate new images to fill the void between slices.
6. `denoise_susan.py`. Provides the functionality of the SUSAN denoising algorithm using the [nipype framework](https://nipype.readthedocs.io/en/latest/index.html) and the underlying [FSL tools](https://web.mit.edu/fsl_v5.0.10/fsl/doc/wiki/FslInstallation(2f)Linux.html).
7. `bias_field_corr_n4.py`. Corrects the input volume using the N4 algorithm to remove the bias field induced in sMRI images bya low-frequency and very smooth signal. The scripts contains two different methods, one to perform the straightforward correction, and the other to monitor the performance of the algorithm.
8. `padding.py`. Contains the functionality of applying *padding* and *letterbox* to the input `sitk.Image` volume, for the transversal view (in the pipeline, since we have applied LPS orientation, `axis=2`).
   - *Padding* is an image processing technique where pixels are added to all sides of the image to fit the desired output resolution.
   - *Letterbox* is an image processing algorithm which consists on interpolating on both sides until one of them reached the desired resolution of its axes, then, we add padding to the other dimension in order to successfully match the desired output. Letterbox involves scaling that will change the effective spacing in the digital image. For CNN input that might be acceptable, but if you want to measure volumes later, you must invert that scaling transformation. That's where the function `reverse_letterbox` comes into place. It first crops the image using the stored padding values to recover the resampled (scaled) image before padding. If a scaling factor other than 1.0 was applied, it then resamples the cropped image back to the original in-plane size (stored in orig_size), effectively reversing the scaling. The function uses nearest-neighbor interpolation by default (appropriate for masks generated by CNNs).
9. `skull_stripping module`. Please, refer to the [skull stripping documentation](./skull_stripping/README.md) for further information.
